"""Test for ReDoS vulnerability fix in whitespace normalization (issue #1454)."""

import pytest
from flywheel.todo import _sanitize_text


class TestWhitespaceNormalization:
    """Test whitespace normalization is safe from ReDoS attacks."""

    def test_simple_whitespace_normalization(self):
        """Test basic whitespace normalization works correctly."""
        # Simple case
        assert _sanitize_text("hello   world") == "hello world"
        assert _sanitize_text("hello\t\tworld") == "hello world"
        assert _sanitize_text("hello\n\nworld") == "hello world"

    def test_mixed_whitespace(self):
        """Test mixed whitespace characters."""
        assert _sanitize_text("hello \t \n world") == "hello world"
        assert _sanitize_text("  hello  world  ") == "hello world"

    def test_no_whitespace(self):
        """Test text without whitespace is unchanged."""
        assert _sanitize_text("helloworld") == "helloworld"
        assert _sanitize_text("hello world") == "hello world"

    def test_extreme_whitespace_edge_case(self):
        """Test extreme edge case that could trigger ReDoS in vulnerable regex.

        This test creates a string with alternating whitespace and non-whitespace
        characters that could cause catastrophic backtracking in vulnerable regex
        implementations. The safe implementation should handle this quickly.
        """
        # Create a potentially problematic string
        # Alternating spaces and characters could cause backtracking
        problematic = "a" * 100 + " " * 100 + "b" * 100

        # Should complete quickly and normalize correctly
        result = _sanitize_text(problematic)
        assert result == "a" * 100 + " " + "b" * 100

    def test_unicode_whitespace(self):
        """Test Unicode whitespace characters are normalized."""
        # Various Unicode whitespace characters
        text = "hello\u200bworld"  # zero-width space
        assert _sanitize_text(text) == "helloworld"

        text = "hello\u200c\u200dworld"  # zero-width non-joiners
        assert _sanitize_text(text) == "helloworld"

    def test_leading_trailing_whitespace_removed(self):
        """Test leading and trailing whitespace is removed."""
        # Note: _sanitize_text normalizes but doesn't strip
        # The strip() is called separately in from_dict
        text = "   hello world   "
        result = _sanitize_text(text)
        # Internal whitespace normalized, but external preserved (strip is separate)
        assert result == " hello world "

    def test_multiple_consecutive_whitespace(self):
        """Test multiple consecutive whitespace becomes single space."""
        assert _sanitize_text("a    b") == "a b"
        assert _sanitize_text("a\t\t\tb") == "a b"
        assert _sanitize_text("a\n\n\nb") == "a b"
        assert _sanitize_text("a \t\n b") == "a b"
