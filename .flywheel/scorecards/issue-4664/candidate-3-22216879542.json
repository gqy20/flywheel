{
  "issue_number": 4664,
  "candidate": 3,
  "run_id": "22216879542",
  "created_at": "2026-02-20T07:00:00Z",
  "summary": "Fix TOCTOU race condition in _ensure_parent_directory by changing exist_ok=False to exist_ok=True",
  "files_changed": [
    "src/flywheel/storage.py",
    "tests/test_issue_4664_toctou_race_fix.py"
  ],
  "test_results": {
    "new_tests_passed": 3,
    "existing_tests_passed": 115,
    "verification_commands": [
      "uv run pytest tests/test_issue_4664_toctou_race_fix.py -v",
      "uv run pytest tests/test_issue_1894_security_mkdir_fix.py -v",
      "uv run pytest tests/test_storage_atomicity.py -v",
      "uv run ruff check src/flywheel/storage.py"
    ]
  },
  "risks": [
    "Using exist_ok=True means we no longer strictly validate that we created the directory ourselves, but this is acceptable because the file-as-directory validation (lines 35-40) still protects against path confusion attacks"
  ],
  "acceptance_criteria_met": [
    "Multiple concurrent processes calling save() on same new path do not raise FileExistsError",
    "File-as-directory validation still works (test_file_as_directory_validation_still_works passes)",
    "All existing tests continue to pass (115/115)"
  ]
}
