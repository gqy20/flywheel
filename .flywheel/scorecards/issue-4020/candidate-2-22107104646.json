{
  "issue_number": 4020,
  "issue_title": "[Perf] next_id() has O(n) complexity scanning all todos",
  "candidate_number": 2,
  "run_id": "22107104646",
  "branch_name": "claude/issue-4020-candidate-2-22107104646",
  "status": "implemented",
  "summary": "Fixed O(n) complexity in next_id() by storing max_id in the JSON file alongside todos list. The fix maintains backward compatibility with old JSON format (array of todos) and migrates automatically on save.",
  "approach": "Store max_id alongside todos in JSON file with new format {\"todos\": [...], \"max_id\": N}. Cache max_id in memory for O(1) next_id() calls. Auto-migrate old format on load.",
  "files_changed": [
    "src/flywheel/storage.py",
    "tests/test_issue_4020_next_id_performance.py",
    "tests/test_storage_atomicity.py"
  ],
  "tests_added": [
    "test_next_id_constant_time_with_large_todo_lists",
    "test_next_id_returns_correct_value_after_load",
    "test_next_id_with_empty_storage",
    "test_next_id_increments_after_add"
  ],
  "performance_improvement": "next_id() now O(1) instead of O(n). Benchmark showed 9.5x time ratio before fix, ~1x after fix.",
  "risks": [
    "JSON file format changed from array to object - old clients will see different structure",
    "Backward compatibility is maintained - old format files can still be read"
  ],
  "commands_run": [
    "uv run pytest tests/test_issue_4020_next_id_performance.py tests/test_storage_atomicity.py -v",
    "uv run pytest tests/ -v --ignore=tests/test_issue_4020_next_id_performance.py --ignore=tests/test_storage_atomicity.py",
    "uv run ruff check src/flywheel/storage.py tests/test_issue_4020_next_id_performance.py tests/test_storage_atomicity.py",
    "uv run ruff check src/flywheel/"
  ],
  "verification_results": {
    "targeted_tests": "10 tests passed",
    "full_test_suite": "106 tests passed",
    "ruff_checks": "All checks passed"
  }
}
