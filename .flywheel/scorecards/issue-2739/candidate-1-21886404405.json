{
  "issue_number": 2739,
  "candidate_number": 1,
  "run_id": "21886404405",
  "stage": "implement",
  "branch_name": "claude/issue-2739-candidate-1-21886404405",
  "plan": {
    "title": "Fix Windows AttributeError for os.fchmod() in TodoStorage.save()",
    "problem_summary": "os.fchmod() is only available on Unix/Linux, not Windows. TodoStorage.save() calls it unconditionally, causing AttributeError on Windows.",
    "root_cause": "storage.py line 112 calls os.fchmod(fd, ...) without checking if the function exists (it doesn't on Windows).",
    "files_to_modify": [
      "src/flywheel/storage.py",
      "tests/test_issue_2027_permissions.py"
    ],
    "tdd_approach": [
      {
        "step": "RED - Add Windows compatibility test",
        "description": "Create test_issue_2739_windows_fchmod.py that simulates Windows behavior by mocking os.fchmod to raise AttributeError, verifying save() still works.",
        "test_file": "tests/test_issue_2739_windows_fchmod.py",
        "expected_before_fix": "Test fails with AttributeError"
      },
      {
        "step": "GREEN - Implement platform-aware fchmod",
        "description": "Modify storage.py line 112 to use hasattr() check for os.fchmod availability. If unavailable (Windows), use os.chmod on the temp file path instead.",
        "source_file": "src/flywheel/storage.py",
        "fix_approach": "hasattr(os, 'fchmod') check with fallback to os.chmod(temp_path, ...)"
      },
      {
        "step": "VERIFY - Run all tests",
        "description": "Run permission and atomicity tests to ensure no regressions on Unix systems.",
        "commands": [
          "uv run pytest tests/test_issue_2027_permissions.py -v",
          "uv run pytest tests/test_issue_2739_windows_fchmod.py -v",
          "uv run pytest tests/test_storage_atomicity.py -v",
          "uv run ruff check src/flywheel/storage.py tests/test_issue_2739_windows_fchmod.py"
        ]
      }
    ],
    "verification_commands": [
      "uv run pytest tests/test_issue_2739_windows_fchmod.py -v",
      "uv run pytest tests/test_issue_2027_permissions.py -v",
      "uv run pytest tests/test_storage_atomicity.py -v",
      "uv run ruff check src/flywheel/storage.py"
    ],
    "acceptance_criteria": [
      "TodoStorage.save() works without AttributeError when os.fchmod is unavailable (simulated Windows)",
      "On Unix systems, temp files still have restrictive 0o600 permissions",
      "Existing permission tests pass on Unix/Linux",
      "Atomic write behavior is preserved across platforms"
    ],
    "risks": [
      "On Windows, tempfile.mkstemp already creates secure files, so skipping fchmod is acceptable",
      "The os.chmod fallback on Windows may not provide identical 0o600 semantics due to Windows ACL differences, but this is documented as acceptable"
    ],
    "implementation_notes": [
      "Use hasattr(os, 'fchmod') check for Python 3.13+ compatibility",
      "On Windows, use os.chmod(temp_path, stat.S_IRUSR | stat.S_IWUSR) as fallback",
      "The fix is minimal and localized to the permission-setting code block"
    ]
  }
}
