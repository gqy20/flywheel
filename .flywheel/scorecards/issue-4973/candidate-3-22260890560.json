{
  "issue_number": 4973,
  "issue_title": "[Bug] _ensure_parent_directory 中 exist_ok=False 与前置检查存在 TOCTOU 竞态窗口",
  "candidate_number": 3,
  "run_id": "22260890560",
  "branch_name": "claude/issue-4973-candidate-3-22260890560",
  "commit_sha": "cdf2c7e",
  "created_at": "2026-02-21T16:00:00Z",
  "status": "ready",
  "summary": {
    "root_cause": "TOCTOU race condition between parent.exists() check and parent.mkdir(exist_ok=False) in _ensure_parent_directory function",
    "fix_approach": "Changed exist_ok=False to exist_ok=True in parent.mkdir(). The file-as-directory validation performed before mkdir already ensures no confusion can occur, making exist_ok=True safe and eliminating the race condition.",
    "files_changed": [
      "src/flywheel/storage.py",
      "tests/test_storage_atomicity.py"
    ],
    "lines_added": 97,
    "lines_removed": 8
  },
  "tests": {
    "added": [
      "test_concurrent_directory_creation_no_race"
    ],
    "passed": 113,
    "failed": 0
  },
  "risks": {
    "breaking_changes": false,
    "performance_impact": "none",
    "security_impact": "none - file-as-directory validation still prevents path confusion"
  },
  "verification": {
    "linter_passed": true,
    "all_tests_passed": true
  }
}
