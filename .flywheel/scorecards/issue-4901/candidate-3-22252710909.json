{
  "issue_number": 4901,
  "issue_title": "[Security] TOCTOU vulnerability in load(): symlink replacement between exists() and read_te",
  "candidate": 3,
  "run_id": "22252710909",
  "branch": "claude/issue-4901-candidate-3-22252710909",
  "created_at": "2026-02-21T08:10:00Z",
  "approach": {
    "description": "Fix TOCTOU vulnerability by opening file once with os.open() and O_NOFOLLOW, then using fstat() on the file descriptor for size check.",
    "key_changes": [
      "Use os.open() with O_NOFOLLOW flag to reject symlinks",
      "Use os.fstat() on file descriptor instead of Path.stat() for size check",
      "Read from file descriptor instead of Path.read_text()",
      "Handle ELOOP error when symlink is detected"
    ],
    "security_impact": "Prevents TOCTOU symlink attacks where attacker could replace file with symlink between exists() check and read operations"
  },
  "tests": {
    "test_file": "tests/test_storage_toctou.py",
    "test_count": 7,
    "all_passed": true,
    "coverage": [
      "test_load_rejects_symlink_directly",
      "test_load_normal_file_still_works",
      "test_load_empty_file_returns_empty_list",
      "test_load_size_check_uses_fstat_not_path_stat",
      "test_load_does_not_use_path_read_text",
      "test_load_does_not_use_path_stat",
      "test_load_oversized_file_still_raises_error"
    ]
  },
  "validation": {
    "all_tests_passed": true,
    "total_tests": 119,
    "linter_passed": true,
    "regression_tests": [
      "All existing storage atomicity tests pass",
      "All other test files pass (119 total)"
    ]
  },
  "files_changed": [
    "src/flywheel/storage.py",
    "tests/test_storage_toctou.py"
  ]
}
