name: Evaluate Priorities

on:
  schedule:
    - cron: "15 * * * *" # At minute 15 (15min after scan)
  issues:
    types: [opened, edited, labeled, reopened]
  workflow_dispatch:

permissions:
  contents: read
  issues: write
  id-token: write

concurrency:
  group: evaluate-priorities
  cancel-in-progress: false

jobs:
  evaluate:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Re-evaluate priorities with Claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            Re-evaluate open issue priorities for this repository.
            First, load and follow `.claude/skills/flywheel-priority-evaluate/SKILL.md`.

            Required behavior:
            1. Fetch open issues with title/body/labels.
            2. Re-score each issue as exactly one of `p0|p1|p2|p3` based on impact and urgency.
            3. Normalize labels so each issue has exactly one priority label.
            4. Keep all non-priority labels unchanged.
            5. Summarize changed issues and final priority distribution.
          claude_args: |
            --max-turns 20
            --allowedTools "Read,Glob,Grep,LS,Bash(gh issue:*),Bash(git:*)"

      - name: Event summary
        if: github.event_name == 'issues'
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;
            const issue_number = issue.number;
            const action = context.payload.action;
            console.log(`Evaluated priorities due to issue event: action=${action}, issue=#${issue_number}`);
