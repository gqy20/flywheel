name: Scan Issues

on:
  schedule:
    - cron: "0 * * * *" # Every hour at minute 0
  workflow_dispatch:
    inputs:
      max_issues:
        description: "Max issues to create in one run"
        required: false
        default: "5"
        type: string
      target_dir:
        description: "Directory to scan"
        required: false
        default: "src"
        type: string

permissions:
  contents: read
  issues: write
  id-token: write

concurrency:
  group: scan-issues
  cancel-in-progress: false

jobs:
  scan:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run scan with Claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            Scan repository code and create actionable issues.
            First, load and follow `.claude/skills/flywheel-scan-issues/SKILL.md`.

            Runtime config:
            - MAX_ISSUES: ${{ inputs.max_issues || '5' }}
            - TARGET_DIR: ${{ inputs.target_dir || 'src' }}

            Required behavior:
            1. Scan only files under TARGET_DIR.
            2. Find high-signal problems/opportunities suitable for tracked issues.
            3. Deduplicate against existing open issues by intent/title.
            4. Create at most MAX_ISSUES new issues for this run.
            5. Apply one priority label (`p0`/`p1`/`p2`/`p3`) and one type label when possible.
            6. Keep issue body concise: problem, location, impact, expected fix direction.
          claude_args: |
            --max-turns 25
            --allowedTools "Read,Glob,Grep,LS,Bash(rg:*),Bash(find:*),Bash(gh issue:*),Bash(git:*)"

      - name: Summary
        env:
          GH_PAGER: cat
          PAGER: cat
        run: |
          echo "### Scan Results" >> $GITHUB_STEP_SUMMARY
          echo "- Issues created: $(gh issue list --state open --json number | jq 'length')" >> $GITHUB_STEP_SUMMARY
