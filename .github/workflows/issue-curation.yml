name: Issue Curation

on:
  schedule:
    - cron: "50 * * * *"
  workflow_dispatch:
    inputs:
      max_open_issues:
        description: "Target max number of open issues"
        required: false
        default: "20"
        type: string

permissions:
  contents: read
  issues: write
  pull-requests: read
  id-token: write

concurrency:
  group: issue-curation
  cancel-in-progress: false

jobs:
  curate:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Curate issue pool with Claude
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          github_token: ${{ secrets.GITHUB_TOKEN }}
          prompt: |
            Curate open issues for this repository.
            First, load and follow `.claude/skills/flywheel-issue-curation/SKILL.md`.

            Runtime config:
            - Max open issues allowed: ${{ inputs.max_open_issues || '20' }}

            Required behavior:
            1. List current open issues with labels and timestamps.
            2. If open issues are within the limit, do nothing and summarize.
            3. If above limit, close only the required number of issues to reach limit.
            4. Close lower-priority and older issues first.
            5. Never close issues labeled `frozen`.
            6. Add a brief close comment with policy rationale and reopen path.
            7. Post a concise summary comment in workflow output.
          claude_args: |
            --max-turns 20
            --allowedTools "Read,Glob,Grep,LS,Bash(gh issue:*),Bash(git:*)"

      - name: Summary
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_PAGER: cat
          PAGER: cat
        run: |
          echo "### Issue Curation" >> "$GITHUB_STEP_SUMMARY"
          echo "- Open issues after curation: $(gh issue list --state open --json number | jq 'length')" >> "$GITHUB_STEP_SUMMARY"
