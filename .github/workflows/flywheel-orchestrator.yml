name: Flywheel Orchestrator

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:
    inputs:
      max_issues:
        description: "Max issues to create in one run"
        required: false
        default: "5"
        type: string
      target_dir:
        description: "Directory to scan"
        required: false
        default: "src"
        type: string
      candidate_quality_min_score:
        description: "Minimum quality score required for candidate PR (0-100)"
        required: false
        default: "70"
        type: string
      min_fixable_issues:
        description: "Minimum number of fixable open issues required before auto-fix runs"
        required: false
        default: "3"
        type: string
      issue_batch_size:
        description: "Number of highest-priority issues to process per run"
        required: false
        default: "3"
        type: string
      max_open_issues:
        description: "Target max number of open issues for curation"
        required: false
        default: "20"
        type: string
      stage_max_retries:
        description: "Per-stage retry count for staged fix execution"
        required: false
        default: "4"
        type: string
      token_budget_chars:
        description: "Response character budget per candidate run"
        required: false
        default: "1500000"
        type: string
      stage_max_turns_json:
        description: "Optional JSON stage turn overrides, e.g. {\"triage\":15,\"verify\":35}"
        required: false
        default: '{"triage":40,"plan":50,"implement":90,"verify":110,"finalize":45}'
        type: string
      require_scorecard:
        description: "Require structured candidate scorecard files before arbitration"
        required: false
        default: "true"
        type: boolean
      circuit_failure_threshold:
        description: "Circuit breaker consecutive failure threshold"
        required: false
        default: "3"
        type: string
      circuit_cooldown_minutes:
        description: "Circuit breaker cooldown window (minutes)"
        required: false
        default: "120"
        type: string
      debug_logs:
        description: "Enable verbose SDK logs for troubleshooting"
        required: false
        default: "false"
        type: boolean

permissions:
  contents: write
  pull-requests: write
  issues: write
  discussions: write
  actions: read
  id-token: write

concurrency:
  group: flywheel-orchestrator
  cancel-in-progress: false

jobs:
  circuit-breaker:
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.gate.outputs.should_run }}
      reason: ${{ steps.gate.outputs.reason }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Circuit breaker gate
        id: gate
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          FAILURE_THRESHOLD: ${{ inputs.circuit_failure_threshold || '3' }}
          COOLDOWN_MINUTES: ${{ inputs.circuit_cooldown_minutes || '120' }}
        run: |
          python scripts/shared/circuit_breaker.py \
            --failure-threshold "$FAILURE_THRESHOLD" \
            --cooldown-minutes "$COOLDOWN_MINUTES"

  scan:
    needs: circuit-breaker
    if: needs.circuit-breaker.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.13"
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Run scan via SDK
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
          MAX_ISSUES: ${{ inputs.max_issues || '5' }}
          TARGET_DIR: ${{ inputs.target_dir || 'src' }}
          CLAUDE_BACKEND: agent_sdk
          LOG_LEVEL: ${{ inputs.debug_logs && 'DEBUG' || 'INFO' }}
          CLAUDE_SDK_TRACE: "1"
          CLAUDE_SDK_VERBOSE_EVENTS: ${{ inputs.debug_logs && '1' || '0' }}
          CLAUDE_SDK_LOG_PROMPT: ${{ inputs.debug_logs && '1' || '0' }}
          CLAUDE_SDK_HEARTBEAT_SECONDS: ${{ inputs.debug_logs && '10' || '30' }}
          CLAUDE_SDK_IDLE_TIMEOUT_SECONDS: "240"
        run: uv run python scripts/scan.py

      - name: Deduplicate fingerprinted issues
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_PAGER: cat
          PAGER: cat
        shell: bash
        run: |
          set -euo pipefail

          issues_json="$(gh issue list --state open --limit 200 --json number,title,body,createdAt,url)"
          plan="$(
            echo "$issues_json" | jq -r '
              map(
                .fingerprint = (
                  .body
                  | capture("\\[fingerprint:(?<fp>[A-Za-z0-9._-]+)\\]")?
                  | .fp?
                )
              )
              | map(select(.fingerprint != null))
              | sort_by(.fingerprint, .createdAt)
              | group_by(.fingerprint)
              | map(select(length > 1))
              | map({
                  fingerprint: .[0].fingerprint,
                  keep: .[0].number,
                  close: (.[1:] | map(.number))
                })
              | map(select((.close | length) > 0))
              | .[]
              | [.fingerprint, (.keep|tostring), (.close | map(tostring) | join(","))]
              | @tsv
            '
          ))"

          if [ -z "$plan" ]; then
            echo "No duplicate fingerprints detected."
            exit 0
          fi

          while IFS=$'\t' read -r fp keep close_csv; do
            [ -z "${close_csv:-}" ] && continue
            for num in $(echo "$close_csv" | tr ',' ' '); do
              [ -z "$num" ] && continue
              gh issue close "$num" \
                --comment "Auto-dedup: duplicate fingerprint \`$fp\`; keeping oldest issue #$keep as canonical." \
                || true
            done
          done <<< "$plan"

  evaluate:
    needs: [circuit-breaker, scan]
    if: needs.circuit-breaker.outputs.should_run == 'true' && needs.scan.result == 'success'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.13"
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Re-evaluate priorities via SDK
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
          CLAUDE_BACKEND: agent_sdk
          LOG_LEVEL: ${{ inputs.debug_logs && 'DEBUG' || 'INFO' }}
          CLAUDE_SDK_TRACE: "1"
          CLAUDE_SDK_VERBOSE_EVENTS: ${{ inputs.debug_logs && '1' || '0' }}
          CLAUDE_SDK_LOG_PROMPT: ${{ inputs.debug_logs && '1' || '0' }}
          CLAUDE_SDK_HEARTBEAT_SECONDS: ${{ inputs.debug_logs && '10' || '30' }}
          CLAUDE_SDK_IDLE_TIMEOUT_SECONDS: "240"
        run: uv run python scripts/evaluate.py

  select-issue:
    needs: [circuit-breaker, evaluate]
    if: needs.circuit-breaker.outputs.should_run == 'true' && needs.evaluate.result == 'success'
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.pick.outputs.should_run }}
      issue_number: ${{ steps.pick.outputs.issue_number }}
      issue_title: ${{ steps.pick.outputs.issue_title }}
      issue_url: ${{ steps.pick.outputs.issue_url }}
      issues_json: ${{ steps.pick.outputs.issues_json }}
      selected_count: ${{ steps.pick.outputs.selected_count }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Select next issue
        id: pick
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GH_REPO: ${{ github.repository }}
          MIN_FIXABLE_ISSUES: ${{ inputs.min_fixable_issues || '3' }}
          ISSUE_BATCH_SIZE: ${{ inputs.issue_batch_size || '3' }}
        run: python scripts/shared/select_issue.py

  generate-candidates:
    needs: [circuit-breaker, select-issue]
    if: needs.circuit-breaker.outputs.should_run == 'true' && needs.select-issue.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        issue: ${{ fromJson(needs.select-issue.outputs.issues_json) }}
        candidate_id: [1, 2, 3]
    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.13"
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Generate candidate PR via SDK
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
          CLAUDE_BACKEND: agent_sdk
          ISSUE_NUMBER: ${{ matrix.issue.number }}
          ISSUE_TITLE: ${{ matrix.issue.title }}
          ISSUE_URL: ${{ matrix.issue.url }}
          CANDIDATE_ID: ${{ matrix.candidate_id }}
          RUN_ID: ${{ github.run_id }}
          CLAUDE_MAX_TURNS: "60"
          CLAUDE_STAGE_MAX_RETRIES: ${{ inputs.stage_max_retries || '4' }}
          CLAUDE_TOKEN_BUDGET_CHARS: ${{ inputs.token_budget_chars || '1500000' }}
          CLAUDE_STAGE_MAX_TURNS_JSON: ${{ inputs.stage_max_turns_json || '{"triage":40,"plan":50,"implement":90,"verify":110,"finalize":45}' }}
          LOG_LEVEL: ${{ inputs.debug_logs && 'DEBUG' || 'INFO' }}
          CLAUDE_SDK_TRACE: "1"
          CLAUDE_SDK_VERBOSE_EVENTS: ${{ inputs.debug_logs && '1' || '0' }}
          CLAUDE_SDK_LOG_PROMPT: ${{ inputs.debug_logs && '1' || '0' }}
          CLAUDE_SDK_HEARTBEAT_SECONDS: ${{ inputs.debug_logs && '10' || '30' }}
          CLAUDE_SDK_IDLE_TIMEOUT_SECONDS: "300"
        run: timeout 55m uv run python scripts/fix.py

      - name: Quality gate candidate PR
        id: quality_gate
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ matrix.issue.number }}
          CANDIDATE_ID: ${{ matrix.candidate_id }}
          RUN_ID: ${{ github.run_id }}
          MIN_SCORE: ${{ inputs.candidate_quality_min_score || '70' }}
          GH_PAGER: cat
          PAGER: cat
        shell: bash
        run: |
          set -euo pipefail

          branch="claude/issue-${ISSUE_NUMBER}-candidate-${CANDIDATE_ID}-${RUN_ID}"
          pr_number="$(gh pr list --head "$branch" --state open --json number --jq '.[0].number // empty')"

          if [ -z "$pr_number" ]; then
            echo "status=no_pr" >> "$GITHUB_OUTPUT"
            echo "score=0" >> "$GITHUB_OUTPUT"
            echo "reason=no_open_pr_found_for_branch" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          pr_json="$(gh pr view "$pr_number" --json number,url,body,isDraft,changedFiles,additions,deletions,statusCheckRollup,files)"

          changed_files="$(echo "$pr_json" | jq -r '.changedFiles // 0')"
          additions="$(echo "$pr_json" | jq -r '.additions // 0')"
          deletions="$(echo "$pr_json" | jq -r '.deletions // 0')"
          total_delta=$((additions + deletions))
          is_draft="$(echo "$pr_json" | jq -r '.isDraft')"

          tests_touched="$(echo "$pr_json" | jq -r '
            [.files[].path
             | test("(^tests/|/tests/|^test_.*\\.py$|_test\\.py$|/test_.*\\.py$)")]
            | any
          ')"

          checks_ok="$(echo "$pr_json" | jq -r '
            ([.statusCheckRollup[]?
              | if has("conclusion") then .conclusion
                elif has("state") then .state
                else "SUCCESS" end
            ]
            | all(. == "SUCCESS" or . == "NEUTRAL" or . == "SKIPPED"))
          ')"

          body="$(echo "$pr_json" | jq -r '.body // ""')"
          has_summary="false"
          has_tests_run="false"
          has_risks="false"
          if echo "$body" | grep -qi "summary"; then has_summary="true"; fi
          if echo "$body" | grep -qi "tests run"; then has_tests_run="true"; fi
          if echo "$body" | grep -qi "risks/limitations"; then has_risks="true"; fi

          score=100

          if [ "$changed_files" -gt 20 ]; then
            score=$((score - 35))
          elif [ "$changed_files" -gt 12 ]; then
            score=$((score - 20))
          fi

          if [ "$total_delta" -gt 600 ]; then
            score=$((score - 25))
          elif [ "$total_delta" -gt 300 ]; then
            score=$((score - 15))
          fi

          if [ "$tests_touched" != "true" ]; then
            score=$((score - 20))
          fi

          if [ "$has_summary" != "true" ]; then
            score=$((score - 8))
          fi
          if [ "$has_tests_run" != "true" ]; then
            score=$((score - 8))
          fi
          if [ "$has_risks" != "true" ]; then
            score=$((score - 8))
          fi

          if [ "$is_draft" = "true" ]; then
            score=$((score - 40))
          fi

          if [ "$checks_ok" != "true" ]; then
            score=$((score - 30))
          fi

          if [ "$score" -lt 0 ]; then score=0; fi
          if [ "$score" -gt 100 ]; then score=100; fi

          gate_status="passed"
          gate_reason="meets_quality_threshold"
          if [ "$score" -lt "$MIN_SCORE" ]; then
            gate_status="failed"
            gate_reason="score_${score}_below_threshold_${MIN_SCORE}"
            gh pr comment "$pr_number" --body "Auto quality gate rejected this candidate (score: $score, threshold: $MIN_SCORE). This PR is closed to reduce low-quality candidate noise."
            gh pr close "$pr_number" || true
          fi

          echo "status=$gate_status" >> "$GITHUB_OUTPUT"
          echo "score=$score" >> "$GITHUB_OUTPUT"
          echo "reason=$gate_reason" >> "$GITHUB_OUTPUT"
          echo "pr_number=$pr_number" >> "$GITHUB_OUTPUT"
          echo "pr_url=$(echo "$pr_json" | jq -r '.url')" >> "$GITHUB_OUTPUT"

  merge:
    needs: [circuit-breaker, select-issue, generate-candidates]
    if: always() && needs.circuit-breaker.outputs.should_run == 'true' && needs.select-issue.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 45
    strategy:
      fail-fast: false
      matrix:
        issue: ${{ fromJson(needs.select-issue.outputs.issues_json) }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 1

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.13"
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Resolve merge-eligible candidates for this run
        id: eligible
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ matrix.issue.number }}
          RUN_ID: ${{ github.run_id }}
        run: python scripts/shared/select_merge_eligible.py

      - name: Decide best candidate and merge via SDK
        if: steps.eligible.outputs.should_merge == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
          CLAUDE_BACKEND: agent_sdk
          ISSUE_NUMBER: ${{ matrix.issue.number }}
          ELIGIBLE_CSV: ${{ steps.eligible.outputs.eligible_csv }}
          CLAUDE_MAX_TURNS: "25"
          CLAUDE_REQUIRE_SCORECARD: ${{ inputs.require_scorecard || true }}
          LOG_LEVEL: ${{ inputs.debug_logs && 'DEBUG' || 'INFO' }}
          CLAUDE_SDK_TRACE: "1"
          CLAUDE_SDK_VERBOSE_EVENTS: ${{ inputs.debug_logs && '1' || '0' }}
          CLAUDE_SDK_LOG_PROMPT: ${{ inputs.debug_logs && '1' || '0' }}
          CLAUDE_SDK_HEARTBEAT_SECONDS: ${{ inputs.debug_logs && '10' || '30' }}
          CLAUDE_SDK_IDLE_TIMEOUT_SECONDS: "240"
        run: timeout 25m uv run python scripts/merge.py

      - name: Validate structured scorecard
        if: always() && steps.eligible.outputs.should_merge == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ISSUE_NUMBER: ${{ matrix.issue.number }}
          ELIGIBLE_CSV: ${{ steps.eligible.outputs.eligible_csv }}
          GH_PAGER: cat
          PAGER: cat
        shell: bash
        run: |
          set -euo pipefail

          winner=""
          merged_count=0
          for pr in $(echo "$ELIGIBLE_CSV" | tr ',' ' '); do
            [ -z "$pr" ] && continue
            merged_at="$(gh pr view "$pr" --json mergedAt --jq '.mergedAt // empty')"
            if [ -n "$merged_at" ]; then
              winner="$pr"
              merged_count=$((merged_count + 1))
            fi
          done

          if [ "$merged_count" -eq 0 ]; then
            echo "No eligible winner merged from eligible set: $ELIGIBLE_CSV"
            echo "Failing merge job to prevent false-positive success without real merge."
            exit 1
          fi
          if [ "$merged_count" -gt 1 ]; then
            echo "Unexpected: multiple merged winners among eligible candidates."
            exit 1
          fi

          body="$(gh pr view "$winner" --json comments --jq '[.comments[].body | select(test("<!-- arbiter-scorecard -->"))][-1] // empty')"
          if [ -z "$body" ]; then
            echo "Missing structured scorecard marker on winner PR #$winner."
            exit 1
          fi

          payload="$(printf '%s\n' "$body" | awk '/<!-- arbiter-scorecard -->/{getline; print; exit}')"
          if [ -z "$payload" ]; then
            echo "Missing JSON payload after scorecard marker on winner PR #$winner."
            exit 1
          fi

          echo "$payload" | jq -e --argjson issue "$ISSUE_NUMBER" --argjson winner "$winner" '
            (.issue == $issue)
            and (.winner_pr == $winner)
            and (.scores | type == "array")
            and ((.scores | length) >= 2)
            and ([.scores[] | has("pr") and has("correctness") and has("risk") and has("maintainability") and has("tests") and has("total") and has("verdict") and has("reason")] | all)
          ' >/dev/null

  curation:
    needs: [circuit-breaker, merge]
    if: always() && needs.circuit-breaker.outputs.should_run == 'true'
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup uv
        uses: astral-sh/setup-uv@v7
        with:
          python-version: "3.13"
          enable-cache: true

      - name: Install dependencies
        run: uv sync

      - name: Curate issue pool via SDK
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ANTHROPIC_AUTH_TOKEN: ${{ secrets.ANTHROPIC_AUTH_TOKEN }}
          ANTHROPIC_BASE_URL: ${{ secrets.ANTHROPIC_BASE_URL }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
          MAX_OPEN_ISSUES: ${{ inputs.max_open_issues || '20' }}
          CLAUDE_BACKEND: agent_sdk
          LOG_LEVEL: ${{ inputs.debug_logs && 'DEBUG' || 'INFO' }}
          CLAUDE_SDK_TRACE: "1"
          CLAUDE_SDK_VERBOSE_EVENTS: ${{ inputs.debug_logs && '1' || '0' }}
          CLAUDE_SDK_LOG_PROMPT: ${{ inputs.debug_logs && '1' || '0' }}
          CLAUDE_SDK_HEARTBEAT_SECONDS: ${{ inputs.debug_logs && '10' || '30' }}
          CLAUDE_SDK_IDLE_TIMEOUT_SECONDS: "240"
        run: uv run python scripts/curate.py

  summary:
    needs: [circuit-breaker, scan, evaluate, select-issue, generate-candidates, merge, curation]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Pipeline summary
        run: |
          {
            echo "### Flywheel Orchestrator"
            echo "- Circuit breaker: ${{ needs.circuit-breaker.outputs.reason || 'unknown' }}"
            echo "- scan: ${{ needs.scan.result }}"
            echo "- evaluate: ${{ needs.evaluate.result }}"
            echo "- select-issue: ${{ needs.select-issue.result }}"
            echo "- generate-candidates: ${{ needs.generate-candidates.result }}"
            echo "- merge: ${{ needs.merge.result }}"
            echo "- curation: ${{ needs.curation.result }}"
          } >> "$GITHUB_STEP_SUMMARY"
