# 架构设计

## 概述

AI 编程飞轮系统的简化架构，基于 GitHub Actions + Claude API。

---

## 系统架构

```
┌─────────────────────────────────────────────────────────────┐
│                       GitHub Repository                       │
│  ┌────────────────────────────────────────────────────────┐  │
│  │                    Source Code                          │  │
│  └────────────────────────────────────────────────────────┘  │
│                              ↑↓                               │
│  ┌────────────────────────────────────────────────────────┐  │
│  │                    GitHub Issues                        │  │
│  │  p0, p1, p2, p3, frozen                                 │  │
│  └────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                         ↕ GitHub API
┌─────────────────────────────────────────────────────────────┐
│                    GitHub Actions                             │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐     │
│  │ scan.yml      │  │ evaluate.yml  │  │ fix.yml        │     │
│  │ 扫描代码       │  │ 评估优先级    │  │ 自动修复       │     │
│  └───────────────┘  └───────────────┘  └───────────────┘     │
└─────────────────────────────────────────────────────────────┘
                         ↕
┌─────────────────────────────────────────────────────────────┐
│                      Python Scripts                           │
│  ┌───────────────┐  ┌───────────────┐  ┌───────────────┐     │
│  │ scan.py       │  │ evaluate.py   │  │ fix.py         │     │
│  │ + claude.py   │  │               │  │ + validator.py │     │
│  └───────────────┘  └───────────────┘  └───────────────┘     │
└─────────────────────────────────────────────────────────────┘
                         ↕
┌─────────────────────────────────────────────────────────────┐
│                      External APIs                            │
│  ┌───────────────┐  ┌───────────────┐                       │
│  │ Claude API    │  │ gh CLI        │                       │
│  └───────────────┘  └───────────────┘                       │
└─────────────────────────────────────────────────────────────┘
```

---

## 目录结构

```
ai-flywheel/
├── .github/
│   └── workflows/
│       ├── scan.yml          # 扫描代码，创建 Issue
│       ├── evaluate.yml      # 评估优先级
│       └── fix.yml           # 自动修复
│
├── scripts/
│   ├── shared/
│   │   ├── claude.py         # Claude API 封装 (~100 行)
│   │   └── utils.py          # 工具函数 (~50 行)
│   │
│   ├── scan.py               # 扫描 + 创建 Issue (~250 行)
│   ├── evaluate.py           # 评估优先级 (~150 行)
│   └── fix.py                # 自动修复 (~400 行)
│
├── config/
│   └── rules.yml             # 安全规则配置
│
├── docs/
│   ├── prd.md                # 产品需求文档
│   ├── api.md                # API 调研
│   └── arch.md               # 本文档
│
└── target-project/           # 被改进的项目
```

**总代码量**: ~1100 行

---

## 核心组件

### 1. scan.py - 扫描器

**职责**: 扫描代码，发现问题，创建 Issue

```python
class Scanner:
    def scan_directory(self, path)
    def analyze_file(self, filepath)
    def create_issue(self, title, body, labels)
```

**触发**: 每周一 00:00

---

### 2. evaluate.py - 评估器

**职责**: 监控 Issue 标签变化，动态排序

```python
class Evaluator:
    def calculate_score(self, issue)
    def sort_issues(self)
```

**触发**: Issue 标签变更时

---

### 3. fix.py - 修复器

**职责**: 按优先级修复，直接提交

```python
class Fixer:
    def get_next_issue(self)
    def generate_fix(self, issue)
    def validate(self, fix)
    def commit_and_monitor(self)
    def rollback_if_needed(self)
```

**触发**: 每 6 小时

---

## 数据流

```
1. 扫描阶段
   代码文件 → Claude 分析 → 生成 Issue → 打标签(p0-p3)

2. 评估阶段
   Issue 变化 → 重新计算分数 → 更新排序

3. 修复阶段
   获取 Issue → Claude 生成修复 → 验证 → 提交 → 监控 → 失败则回滚
```

---

## API 使用策略

| API | 用途 | 调用方式 |
|-----|------|----------|
| **Claude API** | 代码分析、生成修复 | Python SDK |
| **GitHub API** | Issue/提交操作 | `gh` 命令 |

---

## 安全机制

```yaml
提交前:
  - 文件路径验证
  - 生成/更新测试
  - 本地 lint 检查
  - 本地测试通过

提交后:
  - CI 监控 (30 分钟)
  - 测试失败 → 自动回滚
  - 覆盖率下降 > 5% → 回滚
  - 性能下降 > 10% → 回滚
  - 连续 3 次失败 → 熔断 (frozen)
```

---

## 成本估算

### 开发成本
- **工作量**: 6-8 周
- **代码量**: ~1100 行

### 运营成本 (月度)
- **Claude API**: $50-200
- **GitHub Actions**: $0-20
- **总计**: $50-220

---

## 实施计划

| 阶段 | 内容 | 交付物 |
|------|------|--------|
| Week 1-2 | scan.py + scan.yml | 能创建 Issue |
| Week 3 | evaluate.py + evaluate.yml | 能动态排序 |
| Week 4-5 | fix.py + fix.yml | 能自动修复 |
| Week 6 | 安全加固 + 监控 | 生产就绪 |

---

## 参考资料

- [PRD](./prd.md)
- [API 调研](./api.md)
